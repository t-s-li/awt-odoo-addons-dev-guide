# awt-odoo-addons-dev-guide
# 我們採用以下最佳實踐指南

開發 Odoo 附加模組（modules）需要遵循最佳實踐，以確保您的程式碼易於維護、具備擴展性、高效能，並能與未來的 Odoo 版本相容。以下是 Odoo 附加模組開發的最佳實踐指南：

---

### 一、模組結構與組織

1.  **標準模組結構：**
    * 遵循 Odoo 預定義的目錄結構。這讓您的模組對其他開發者而言易於理解和導航。
    * 基本檔案：`__init__.py` (用於 Python 套件)、`__manifest__.py` (模組藍圖)。
    * 常用目錄：
        * `models/`：定義模型（資料庫表格）和業務邏輯的 Python 檔案。
        * `views/`：定義視圖（表單、樹狀、看板、搜尋）、選單和動作的 XML 檔案。
        * `data/`：用於初始資料、配置記錄和系統級資料的 XML 或 CSV 檔案。
        * `security/`：用於群組和記錄規則的 XML 檔案，以及用於存取權限的 `ir.model.access.csv`。
        * `static/`：網頁資產（CSS、JS、圖片、函式庫）。
        * `controllers/`：用於 HTTP 路由的 Python 檔案（例如，網站控制器）。
        * `wizard/`：用於多步驟操作的暫時模型及其視圖。
        * `report/`：報表定義（Python 和 XML）。
        * `i18n/`：翻譯檔案（`.po`、`.pot`）。
        * `demo/`：演示資料（僅在啟用「載入演示資料」時載入）。
        * `tests/`：用於自動化測試的 Python 檔案。
        * `doc/`：模組文件。

2.  **檔案命名慣例：**
    * **Python 檔案：**
        * 模型檔案：如果一個模組有多個模型，將相關模型分組到一個以主要模型命名的 Python 檔案中（例如，`school.py` 對應 `school.class` 和 `school.students` 模型）。如果只有一個模型，則使用模組名稱。
        * 控制器檔案：通常是單一檔案，以模組名稱命名（例如，`my_module.py`）。
    * **XML 檔案：**
        * 視圖：`<model_name>_views.xml`（例如，`product_product_views.xml`）。如果特定，則加上 `_tree`、`_form`、`_kanban`、`_search` 等後綴。
        * 模板 (QWeb)：`<model_name>_templates.xml`。
        * 選單：`<model_name>_menus.xml`。
        * 資料：`<model_name>_data.xml`。
        * 安全：`_groups.xml` 用於群組，`ir.model.access.csv` 用於存取權限。
        * 精靈：`<transient_model_name>_views.xml`。
    * **ID 和命名：**
        * 使用描述性且唯一的 XML ID。慣例為：`module_name.record_id`。
        * 選單：`_menu` 用於主選單，`_menu_do_stuff` 用於子選單。
        * 動作：`_action` 用於主要動作。
        * 群組：`_group_<group_name>`。
        * 規則：`_rule_<group_name>`。

---

### 二、Python 編碼標準

1.  **符合 PEP 8 規範：**
    * 遵循 Python 官方風格指南 (PEP 8)，以提高程式碼的可讀性和一致性。
    * **縮排：** 使用 4 個空格進行縮排。
    * **行長度：** 將行限制在 79-85 個字元。
    * **命名慣例：**
        * 變數/函式：**`snake_case`** (小寫與底線)。
        * 類別名稱：**`CamelCase`** (例如，`MyModel`)。
        * 模型名稱：單數形式 (例如，`my.model` 而非 `my.models`)。
        * 欄位名稱：**`snake_case`**。
    * **匯入：**
        * 將匯入語句放在檔案頂部。
        * 順序：標準函式庫、第三方函式庫、Odoo 匯入、本地模組匯入。
        * 每行一個匯入。

2.  **Odoo 特有慣例：**
    * **`_name` (模型名稱)：** 使用單數形式，例如 `_name = 'res.partner'` 而非 `res.partners`。
    * **`_description`：** 始終為您的模型提供有意義的描述。
    * **方法命名：**
        * 計算欄位：**`_compute_<field_name>`** (例如，`_compute_total_amount`)。
        * 搜尋方法：**`_search_<field_name>`**。
        * 約束方法：**`_check_<constraint_name>`** 或 **`_check_something`**。
        * Onchange 方法：**`_onchange_<field_name>`**。
        * 動作方法：前綴為 **`action_`** (例如，`action_confirm`)。
    * **記錄集操作：**
        * 對於應在單一記錄上操作的方法，使用 **`self.ensure_one()`**。
        * 使用 **`mapped()`**、**`filtered()`**、**`sorted()`**、**`browse()`** 進行高效的記錄集操作。如果 ORM 方法可以做到，則避免在記錄集上使用 `for` 迴圈進行基本篩選/映射。
        * 覆寫 `create()` 或 `write()` 時，請務必適當地呼叫 `super()`。

3.  **SQL 查詢：**
    * 除非絕對必要，否則避免使用原始 SQL 查詢。盡可能利用 Odoo 的 ORM。
    * 如果無法避免原始 SQL，請使用 `self.env.cr.execute()` 並參數化您的查詢以防止 SQL 注入。
    * 優化 SQL 查詢：避免 N+1 查詢，使用索引欄位。

4.  **程式碼可讀性與可維護性：**
    * **文件字串 (Docstrings)：** 為模組、類別和方法編寫清晰簡潔的文件字串，解釋其目的、參數和回傳值。
    * **註釋：** 對於複雜邏輯或不明顯的程式碼使用註釋。
    * **DRY 原則 (Don't Repeat Yourself)：** 建立可重複使用的函式和類別，以最小化程式碼重複。
    * **模組化：** 保持模組輕量化並專注於單一邏輯功能單元。將大型模組分解為更小、更易於管理的模組。
    * **SOLID 原則：** 雖然沒有嚴格強制執行，但理解和應用 SOLID 原則（單一職責、開放/封閉、里氏替換、介面隔離、依賴反轉）可以產生更健壯和可擴展的程式碼。
    * **錯誤處理：** 實作適當的錯誤處理（try-except 區塊）和日誌記錄（`_logger.info`、`_logger.warning`、`_logger.error`）以進行調試和監控。

---

### 三、XML 編碼標準與視圖

1.  **視圖繼承：**
    * 優先考慮使用 **`xpath`** 進行視圖繼承，而非替換整個視圖。這確保了 Odoo 升級期間的相容性並減少合併衝突。
    * 為 `xpath` 使用特定的 `expr` 以精確定位元素。

2.  **有意義的 ID：** 為視圖、選單和動作使用描述性的 XML ID。

3.  **必填欄位：** 始終在表單、樹狀和搜尋視圖上顯示**必填欄位**。

4.  **小部件 (Widgets)：** 利用適當的 Odoo 小部件用於欄位，以確保一致的行為和使用者體驗（例如，`widget="selection"`、`widget="many2one"`）。

5.  **註釋：** 在 XML 中包含註釋以解釋特定元素或區塊的目的。

6.  **翻譯：** 對於 QWeb 模板使用 `t-esc` 和 `t-out`，對於 Python 程式碼中使用 `_()` 進行可翻譯字串。在 XML 視圖中，將可翻譯文本用 `<data translate="1">` 包裹。

7.  **`no_create`、`no_edit`、`no_open`：** 在視圖中不需要直接建立/編輯/開啟相關記錄的 `Many2one` 欄位中使用這些屬性。

---

### 四、安全性與存取權限

1.  **嚴格存取控制：**
    * 在 `ir.model.access.csv` 中為每個模型定義精確的存取權限（讀取、寫入、建立、刪除）。
    * 建立特定的使用者群組 (`<module_name>_groups.xml`) 並為其分配適當的存取權限。
    * 實作**記錄規則** (`ir.rule`) 以根據使用者群組或特定條件限制資料存取（例如，使用者只能查看自己的記錄）。

2.  **切勿硬編碼敏感資訊：** 對於 API 密鑰、密碼等，使用可配置參數或環境變數。

---

### 五、效能優化

1.  **惰性載入 (Lazy Loading)：** Odoo 的 ORM 通常使用惰性載入。了解何時執行查詢以避免不必要的資料庫存取。

2.  **批次操作：** 在記錄集上使用 `create()`、`write()`、`unlink()`，而不是在迴圈中疊代並單獨呼叫它們，這樣效率更高。

3.  **計算欄位：** 僅在必要時為計算欄位定義 `store=True`。如果欄位經常計算且其依賴關係很少更改，儲存它可以提高效能。

4.  **`@api.depends`：** 正確指定計算欄位的依賴關係，以確保它們僅在相關資料更改時才重新計算。

5.  **`@api.multi`、`@api.one`、`@api.model`：** 了解何時使用每個裝飾器。`@api.model` 用於不需要 `self` 作為記錄集的方法，`@api.multi` 用於在記錄集上操作的方法，`@api.one`（在較新的 Odoo 版本中已棄用，優先使用 `self.ensure_one()` 和 `@api.multi`）用於預期在單一記錄上操作的方法。

6.  **避免在迴圈中進行過度查詢：** 注意 N+1 查詢問題。謹慎使用 `sudo()`，僅在需要繞過安全檢查時使用。

7.  **快取：** 利用 Odoo 的快取機制，如果效能至關重要，請考慮使用外部快取解決方案（如 Redis）來處理頻繁存取的靜態資料。

---

### 六、測試與調試

1.  **自動化測試：**
    * 為您的模組編寫全面的單元測試和功能測試。Odoo 內建了測試框架。
    * 測試應涵蓋所有主要功能、邊緣情況和錯誤場景。

2.  **日誌記錄：** 有效利用 Python 的 `logging` 模組進行調試和追蹤應用程式行為。

3.  **開發者模式：** 利用 Odoo 的開發者模式來檢查視圖、模型、欄位和調試問題。

4.  **調試工具：** 使用 IDE 調試工具（例如，PyCharm 調試器）、`pdb` (Python 調試器) 和瀏覽器擴充功能（如 Odoo Debug Toolbar）。

5.  **分析：** 使用分析工具來識別程式碼中的效能瓶頸（例如，`cProfile`）。

---

### 七、部署與維護

1.  **版本控制：** 使用 Git 或類似的版本控制系統管理您的程式碼、追蹤更改並促進協作。

2.  **獨立的自定義附加模組路徑：** 將您的自定義模組保存在與 Odoo 核心附加模組分開的專用 `custom_addons` 目錄中。配置 Odoo 以識別此路徑。

3.  **模組版本控制：** 遵循 Odoo 的版本控制慣例（例如，Odoo 17 的初始版本為 `17.0.1.0.0`）。

4.  **文件：** 在 `README.rst` 檔案中記錄您的模組功能、依賴項和安裝步驟。

5.  **向後相容性：** 如果您正在擴展核心模組，請努力實現與現有 Odoo 功能的向後相容性。

6.  **定期更新：** 隨時了解最新的 Odoo 版本和安全補丁。定期審核您的自定義模組的相容性。

7.  **預演環境：** 在部署到生產環境之前，務必在預演環境中測試新模組或重大更改。

8.  **資料遷移：** 當更新更改資料結構的模組時，請使用 Odoo 的資料遷移腳本來規劃資料遷移。

遵循這些最佳實踐，您可以開發出穩健、高效且易於維護的 Odoo 附加模組，這些模組能與核心系統無縫整合並滿足您的業務需求。
