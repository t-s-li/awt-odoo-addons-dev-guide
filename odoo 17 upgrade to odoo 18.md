---
要將 Odoo 17 的附加模組升級到 Odoo 18，您需要考慮多個層面的修改，因為 Odoo 每個主要版本都會引入架構變化、API 更新、棄用功能以及新的最佳實踐。以下是您需要檢查和修改的主要方面：

---

### 一、Python 程式碼變更

1.  **API 變更與棄用：**
    * **ORM API 調整：** 檢查是否有任何在 Odoo 17 中已棄用但在 Odoo 18 中被移除或行為改變的 ORM 方法。這通常涉及 `_logger.warning` 訊息的舊 API 用法。
    * **`@api.one` 徹底移除：** 在 Odoo 17 中已不鼓勵使用 `@api.one`，在 Odoo 18 中應該會被**徹底移除**。所有使用 `@api.one` 的方法都必須改為 `@api.multi` 並使用 `self.ensure_one()`。
    * **新裝飾器/舊裝飾器行為變更：** 留意 `@api.depends`、`@api.constrains` 等裝飾器的行為是否有微調或新增參數。
    * **Context 變更：** `self.with_context()` 的行為或其內部結構可能有微小調整。
    * **環境 (`env`) 變更：** 某些 `self.env` 相關的方法或屬性可能已更新。

2.  **模型 (`models`) 相關：**
    * **欄位類型變更：** 某些欄位的預設行為或選項可能已更新。例如，`fields.Char` 的 `translate` 參數預設值可能不同。
    * **模型繼承：** 檢查抽象模型或經典繼承是否有行為上的細微變化。
    * **`_name` 命名約定：** 雖然通常穩定，但需確認是否有新的模型命名最佳實踐。

3.  **控制器 (`controllers`) 相關：**
    * **路由裝飾器：** `http.route` 裝飾器是否有新增參數或行為改變。
    * **請求處理：** 請求物件 (`request`) 的屬性或方法是否有更新。
    * **QWeb 渲染：** 模板渲染方法 (`request.render`) 的參數是否有變化。

4.  **安全 (`security`) 相關：**
    * **預設權限：** Odoo 核心模組的預設存取權限可能會有所調整，這可能影響您自定義模組的行為。
    * **記錄規則 (`ir.rule`)：** 檢查是否有新的上下文或變數可以在記錄規則中使用。

5.  **Python 版本兼容性：**
    * Odoo 18 可能會要求更高版本的 Python。如果 Odoo 17 運行在 Python 3.9，而 Odoo 18 要求 Python 3.10 或 3.11，則需要檢查您的程式碼是否存在不兼容的語法或庫依賴。

---

### 二、XML 檔案變更

1.  **視圖 (`views`) 相關：**
    * **XML ID 命名空間：** 確保所有 XML ID 仍然遵循 `module_name.record_id` 的約定，並且在升級過程中沒有衝突。
    * **Xpath 表達式：** Odoo 核心視圖的內部結構可能會改變，這會導致您模組中繼承視圖的 `xpath` 表達式失效。這是升級中最常見的問題之一，需要**仔細檢查並調整所有 `xpath`。**
        * 檢查 `form`、`tree`、`kanban`、`search` 等視圖的結構變更。
        * 檢查核心模組新增或移除的欄位或按鈕，這些可能會影響您的繼承點。
    * **QWeb 模板：** QWeb 引擎或其上下文可能會有細微調整，導致某些模板渲染出錯。
    * **自定義小部件 (Widgets) / 屬性 (Attributes)：** 檢查您在 XML 中使用的自定義小部件或屬性是否在 Odoo 18 中仍然兼容或有新版本。

2.  **資料 (`data`) 檔案：**
    * **`noupdate="1"`：** 確保需要避免在模組更新時被覆寫的資料記錄設定了 `noupdate="1"`。
    * **預設資料：** 如果 Odoo 18 核心模組的預設資料有變，您的自定義資料可能需要調整以保持一致性。
    * **CSV 檔案：** 檢查 `ir.model.access.csv` 等 CSV 檔案的格式和內容是否有變化。

---

### 三、JavaScript 和 Web 資產變更

1.  **Odoo Web 框架：** Odoo 18 的前端框架可能會引入顯著變革（例如，從 Owl v1 到 Owl v2 或其他重構），這會影響所有自定義的 JavaScript 程式碼和 Web 元件。
    * **Owl 框架更新：** 如果 Odoo 18 更新了 Owl 的主要版本，那麼組件的生命週期、狀態管理和掛鉤 (`hooks`) 可能需要調整。
    * **JS 模組系統：** Odoo 17 已經使用了 ESM (ECMAScript Modules)，但 Odoo 18 可能會進一步優化或要求更嚴格的導入方式。
    * **前端測試：** 如果有自定義前端測試，其測試框架或工具鏈可能需要更新。

2.  **SCSS/CSS 變數與類別：** Odoo 的前端 UI 可能會進行樣式調整，核心 SCSS 變數或 CSS 類別可能已改變或棄用，這會影響您的自定義樣式。

3.  **Asset Bundles：** `assets` 定義在 `__manifest__.py` 或 XML 中，其捆綁方式或依賴關係可能需要調整。

---

### 四、Manifest 檔案 (`__manifest__.py`) 變更

1.  **Odoo 版本指定：** 將 `__manifest__.py` 中的 `'version'` 欄位更新為 Odoo 18 的版本（例如 `'18.0.1.0.0'`）。
2.  **依賴關係 (`depends`)：** 檢查您的模組是否依賴 Odoo 18 中已移除、更名或新增的核心模組。
3.  **分類 (`category`)：** Odoo 應用程式商店的分類可能會有更新。
4.  **`external_dependencies`：** 如果您的模組依賴於任何外部 Python 庫，確認這些庫在 Odoo 18 的預設環境中仍然可用或需要更新版本。

---

### 五、資料遷移腳本 (Migration Scripts)

1.  **資料結構變更：** 如果 Odoo 18 核心模組對資料庫結構（例如：模型名稱、欄位名稱、欄位類型、約束等）進行了重大更改，您的附加模組也需要相應調整，並且可能需要編寫資料遷移腳本。
2.  **`pre-migration` 與 `post-migration`：** 在 Odoo 升級框架中，您可以在模組中添加 `pre-migration` 和 `post-migration` 資料夾，放置在 `data` 目錄的**同級**。
    * `pre-migration` 腳本：在 Odoo 進行資料庫結構更新之前運行，用於處理舊資料，避免因結構變更而導致的資料丟失或錯誤。
    * `post-migration` 腳本：在 Odoo 完成資料庫結構更新後運行，用於調整新結構下的資料，或執行任何清理/轉換任務。
    * 範例：如果一個欄位從 `Char` 類型變為 `Selection`，或者一個模型被拆分為兩個，您就需要遷移腳本來處理現有資料。

---

### 六、測試

1.  **更新測試：** 根據上述所有修改，您的單元測試和功能測試都需要更新以符合 Odoo 18 的行為和 API。
2.  **完整測試套件運行：** 在升級後，務必運行所有測試，並手動測試模組的所有功能，以確保其正常運作。

---

### 升級策略建議：

1.  **從 Odoo 17 的最新小版本開始：** 確保您的 Odoo 17 模組在升級前是基於 Odoo 17 的最新穩定版本。
2.  **逐步升級：** 不建議一次性升級所有模組。從最核心、依賴最少的模組開始，逐步擴展。
3.  **使用 Odoo 升級工具：** 對於資料庫升級，可以使用 Odoo 官方提供的升級服務，或社群工具如 OpenUpgrade。但這些工具主要處理核心資料，模組程式碼的修改仍需手動或自動化工具輔助。
4.  **版本控制的分支管理：** 為 Odoo 18 的升級建立一個單獨的 Git 分支，這樣可以隔離工作，並在必要時輕鬆回溯。
5.  **詳細記錄：** 在升級過程中，詳細記錄所有遇到的問題和解決方案，這對未來的升級非常有幫助。

升級 Odoo 附加模組是一個複雜的過程，尤其當模組包含大量客製化和複雜邏輯時。建議您在專門的開發環境中進行升級，並確保有完整的備份。